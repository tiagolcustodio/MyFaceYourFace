{% extends "base.html" %}
{% block content %}

<div class="layout">
  <div class="col-left">
    {% if community.icon_path %}
      <img class="avatar-img" src="{{ url_for('static', filename=community.icon_path) }}" alt="Community">
    {% else %}
      <div class="avatar-placeholder"></div>
    {% endif %}
  </div>

  <div class="col-main">
    <h2 style="margin-top:0;">{{ community.name }}</h2>

    {% if community.description %}
      <div class="muted" style="margin-bottom:8px;">{{ community.description }}</div>
    {% endif %}

    <div class="muted" style="margin-bottom:12px;">
      created by <b>{{ community.created_by_name }}</b>
    </div>

    <div style="margin-bottom:12px;">
      {% if is_member %}
        <span class="muted"><b>You are a member</b></span>
        {% if not is_creator %}
          <form method="post" action="{{ url_for('community_leave', cid=community.id) }}" style="display:inline;">
            <button type="submit" class="btn-danger" style="margin-left:10px;"
                    onclick="return confirm('Are you sure you want to leave this community?');">
              Leave
            </button>
          </form>
        {% endif %}
      {% else %}
        <span class="muted"><b>You are not a member of this community</b></span>
        <form method="post" action="{{ url_for('community_join', cid=community.id) }}" style="display:inline;">
          <button type="submit" style="margin-left:10px;">Join community</button>
        </form>
      {% endif %}
    </div>

    {% if is_creator %}
      <div style="margin-bottom:14px;">
        <a class="inline-link" href="{{ url_for('edit_community', cid=community.id) }}">Edit community</a>
      </div>
    {% endif %}

    <!-- ✅ Topics header with Create New Topic on the right -->
    <div class="section-head">
      <h3 style="margin:0;">Topics</h3>

      {% if is_member %}
        <form method="post"
              action="{{ url_for('create_topic_route', cid=community.id) }}"
              class="topic-create-inline">
          <input name="title"
                 class="topic-title-input"
                 maxlength="80"
                 placeholder="New topic title..."
                 required>
          <button type="submit">Create New Topic</button>
        </form>
      {% endif %}
    </div>

    <!-- ✅ Topics list in a separate box -->
    <div class="panel" style="margin-top:12px;">
      {% if not is_member %}
        <div class="muted">Join the community to view and create topics.</div>

      {% else %}
        {% if topics|length == 0 %}
          <div class="muted">No topics yet.</div>
        {% else %}
          <div class="topic-list">
            {% for t in topics %}
              <div class="topic-card">
                <a href="{{ url_for('topic_page', cid=community.id, tid=t.id) }}" class="topic-link">
                  <div class="topic-title">{{ t.title }}</div>
                  <div class="muted">Last update: {{ t.updated_at }}</div>
                </a>

                {% if user.id == t.created_by_user_id %}
                  <form method="post"
                        action="{{ url_for('delete_topic', cid=community.id, tid=t.id) }}"
                        onsubmit="return confirm('Delete this topic?');"
                        class="topic-actions">
                    <button type="submit" class="icon-delete" aria-label="Delete">X</button>
                  </form>
                {% endif %}
              </div>
            {% endfor %}
          </div>

          {% if topics_pagination.show %}
            <div class="pagination">
              {% if topics_pagination.has_prev %}
                <a class="page-link" href="{{ url_for('community_page', cid=community.id, page=topics_pagination.prev_page) }}">Prev</a>
              {% endif %}

              <span class="page-info">Page {{ topics_pagination.page }} / {{ topics_pagination.total_pages }}</span>

              {% if topics_pagination.has_next %}
                <a class="page-link" href="{{ url_for('community_page', cid=community.id, page=topics_pagination.next_page) }}">Next</a>
              {% endif %}
            </div>
          {% endif %}
        {% endif %}
      {% endif %}
    </div>
  </div>

  <div class="col-right">
    <div class="sidebox">
      <div class="sidebox-header">
        <h3>Members</h3>
        <a class="sidebox-link" href="{{ url_for('community_members', cid=community.id) }}">View all members</a>
      </div>

      {% if members_random|length == 0 %}
        <div class="muted">No members yet.</div>
      {% else %}
        <div class="grid-3">
          {% for m in members_random %}
            <div class="grid-item">
              <a href="{{ url_for('user_profile', username=m.username) }}" class="grid-link">
                {% if m.profile_pic_path %}
                  <img class="square-img" src="{{ url_for('static', filename=m.profile_pic_path) }}" alt="Member">
                {% else %}
                  <div class="friend-avatar"></div>
                {% endif %}
                <div class="grid-name">{{ m.display_name }}</div>
              </a>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    </div>
  </div>
</div>

{% endblock %}
